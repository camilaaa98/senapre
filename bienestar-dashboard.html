<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bienestar (Liderazgo) - SenApre</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="assets/img/asi.png" alt="ASI Logo"
                    style="width: 100px; height: 100px; object-fit: cover; margin-bottom: 10px; border-radius: 50%;">
                <h3>Bienestar</h3>
                <div class="sidebar-subtitle" id="userNameSub"
                    style="text-align: center; color: rgba(255,255,255,0.7); font-size: 0.8rem;">Responsable</div>
            </div>
            <nav class="sidebar-menu">
                <li class="menu-item"><a href="admin-dashboard.html" class="menu-link"
                        style="background: rgba(255,255,255,0.08);">
                        <div class="menu-icon"><i class="fas fa-arrow-left"></i></div><span>Volver al Panel</span>
                    </a></li>
                <li class="menu-item"><a href="bienestar-dashboard.html" class="menu-link active">
                        <div class="menu-icon"><i class="fas fa-users-cog"></i></div><span>Gestión de Líderes</span>
                    </a></li>
                <li class="menu-item"><a href="admin-aprendices.html#poblacion" class="menu-link">
                        <div class="menu-icon"><i class="fas fa-users"></i></div><span>Tipo de Población</span>
                    </a></li>
                <li class="menu-item"><a href="#" onclick="authSystem.logout()" class="menu-link">
                        <div class="menu-icon"><i class="fas fa-sign-out-alt"></i></div><span>Cerrar Sesión</span>
                    </a></li>
            </nav>
            <div class="sidebar-footer" style="margin-top: auto; padding: 20px; text-align: center;">
                <img src="assets/img/logosena.png" alt="SENA Logo" style="height: 60px; width: auto; opacity: 0.9;">
            </div>
        </aside>

        <main class="main-content">
            <div class="content-header" style="text-align: center; margin-bottom: 30px; width: 100%;">
                <h1 class="content-title">Panel de Liderazgo</h1>
                <p class="content-description">Gestión de líderes estudiantiles y comunicaciones</p>
            </div>

            <div class="card" style="margin-bottom: 25px;">
                <div class="card-header">
                    <h3 class="card-title">Filtros y Acciones Masivas</h3>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1.5fr; gap: 15px; align-items: end;">
                    <div class="form-group">
                        <label class="form-label">Filtrar por Tipo</label>
                        <select id="filtroTipo" class="form-control" onchange="cargarLideres()">
                            <option value="todos">Todos los Líderes</option>
                            <option value="principales">Voceros Principales</option>
                            <option value="suplentes">Voceros Suplentes</option>
                            <option value="enfoque">Enfoque Diferencial</option>
                            <option value="representantes">Representantes de Jornada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Buscador</label>
                        <input type="text" id="buscarLider" class="form-control" placeholder="Nombre o Documento..."
                            oninput="filtrarTabla()">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="prepararMensajeMasivo('email')" class="btn-primary"
                            style="background: #00324D; flex: 1;">
                            <i class="fas fa-envelope"></i> Email Masivo
                        </button>
                        <button onclick="prepararMensajeMasivo('whatsapp')" class="btn-primary"
                            style="background: #25D366; flex: 1;">
                            <i class="fab fa-whatsapp"></i> WhatsApp Masivo
                        </button>
                    </div>
                </div>
            </div>

            <div class="table-container animate-slide-in">
                <table class="data-table" id="tablaLideres">
                    <thead>
                        <tr>
                            <th>Documento</th>
                            <th>Aprendiz</th>
                            <th>Tipo de Líder</th>
                            <th>Ficha</th>
                            <th>Contacto</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyLideres">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 30px;">Cargando líderes...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Modal Mensajería -->
    <div id="modalMensajeria" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px;">
            <h3 id="tituloModalMensaje">Enviar Mensaje</h3>
            <div class="form-group">
                <label class="form-label">Asunto / Título</label>
                <input type="text" id="asuntoMensaje" class="form-control"
                    placeholder="Ej: Citación a reunión ordinaria">
            </div>
            <div class="form-group">
                <label class="form-label">Cuerpo del Mensaje</label>
                <textarea id="cuerpoMensaje" class="form-control" rows="6"
                    placeholder="Escriba el mensaje aquí..."></textarea>
            </div>
            <div
                style="background: #eef2ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85rem;">
                <p style="margin: 0; color: #4338ca;"><i class="fas fa-info-circle"></i> Este mensaje se enviará a todos
                    los líderes que coincidan con el filtro actual (<strong id="tipoSeleccionado"></strong>).</p>
                <p style="margin: 5px 0 0 0; color: #4338ca;"><i class="fas fa-user-tie"></i> También se notificará a
                    sus Instructores Líderes para coordinar el permiso.</p>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="cerrarModalMensaje()" class="btn-primary" style="background: #666;">Cancelar</button>
                <button id="btnEnviarMensaje" onclick="enviarMensajeMasivo()" class="btn-primary">Enviar</button>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        let lideresData = [];
        let modoMensaje = '';

        document.addEventListener('DOMContentLoaded', () => {
            const user = authSystem.getCurrentUser();
            if (user) document.getElementById('userNameSub').textContent = user.nombre;
            cargarLideres();
        });

        async function cargarLideres() {
            const tipo = document.getElementById('filtroTipo').value;
            const tbody = document.getElementById('tbodyLideres');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;"><i class="fas fa-spinner fa-spin"></i> Cargando líderes...</td></tr>';
            try {
                const response = await fetch(`api/bienestar.php?action=getLideres&filtro=${tipo}`);
                if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}`);
                }
                const result = await response.json();
                if (result.success && Array.isArray(result.data)) {
                    lideresData = result.data;
                    renderLideres(lideresData);
                } else {
                    throw new Error(result.message || 'Respuesta inesperada del servidor');
                }
            } catch (error) {
                console.error('Error cargando líderes:', error);
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:30px;color:#ef4444;"><i class="fas fa-exclamation-circle"></i> Error al cargar: ${error.message}. Verifique la conexión con el servidor.</td></tr>`;
            }
        }

        function renderLideres(data) {
            const tbody = document.getElementById('tbodyLideres');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay líderes registrados en esta categoría</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(l => `
                <tr>
                    <td>${l.documento}</td>
                    <td><strong>${l.nombre} ${l.apellido}</strong></td>
                    <td><span class="badge" style="background: var(--sena-green); color: white;">${l.tipo}</span></td>
                    <td>${l.detalle}</td>
                    <td>
                        <div style="font-size: 0.9rem;">
                            <i class="fas fa-envelope"></i> ${l.correo || 'N/A'}<br>
                            <i class="fab fa-whatsapp"></i> ${l.telefono || 'N/A'}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filtrarTabla() {
            const term = (document.getElementById('buscarLider').value || '').toLowerCase();
            const filtered = lideresData.filter(l => {
                const nombre = (l.nombre || '').toLowerCase();
                const apellido = (l.apellido || '').toLowerCase();
                const doc = (l.documento || '').toLowerCase();
                return nombre.includes(term) || apellido.includes(term) || doc.includes(term);
            });
            renderLideres(filtered);
        }

        function prepararMensajeMasivo(modo) {
            modoMensaje = modo;
            const tipo = document.getElementById('filtroTipo').options[document.getElementById('filtroTipo').selectedIndex].text;
            document.getElementById('tipoSeleccionado').textContent = tipo;
            document.getElementById('tituloModalMensaje').textContent = `Enviar ${modo === 'email' ? 'Email' : 'WhatsApp'} Masivo`;
            document.getElementById('modalMensajeria').style.display = 'flex';
        }

        function cerrarModalMensaje() {
            document.getElementById('modalMensajeria').style.display = 'none';
        }

        async function enviarMensajeMasivo() {
            const asunto = document.getElementById('asuntoMensaje').value;
            const cuerpo = document.getElementById('cuerpoMensaje').value;
            const tipo = document.getElementById('filtroTipo').value;

            if (!asunto || !cuerpo) {
                alert('Por favor complete todos los campos');
                return;
            }

            const btn = document.getElementById('btnEnviarMensaje');
            btn.disabled = true;
            btn.textContent = 'Enviando...';

            try {
                // Preparamos lista de destinatarios basándonos en los datos cargados y filtrados
                const destinatarios = lideresData.map(l => ({
                    documento: l.documento,
                    email: l.correo,
                    tel: l.telefono,
                    nombre: `${l.nombre} ${l.apellido}`
                }));

                const response = await fetch('api/mensajeria.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        modo: modoMensaje,
                        asunto,
                        cuerpo,
                        destinatarios,
                        tipo_lideres: tipo
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`Mensajes enviados exitosamente a ${result.enviados} líderes y sus instructores.`);
                    cerrarModalMensaje();
                } else {
                    alert('Error enviando mensajes: ' + result.message);
                }
            } catch (error) {
                alert('Error técnico al enviar mensajes');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Enviar';
            }
        }
    </script>
</body>

</html>